package com.googlecode.mapperdao.ops

import com.googlecode.mapperdao._
import java.util.IdentityHashMap

/**
 * entities are converted to PersistOps
 *
 * @author kostantinos.kougios
 *
 * 21 Nov 2012
 */
class PersistCmdFactory {

	private val alreadyProcessed = new IdentityHashMap[Any, PersistCmd[_, _, _]]

	def toInsertCmd[ID, PC <: DeclaredIds[ID], T](
		entity: Entity[ID, PC, T],
		o: T) = insert(entity, o)

	private def insert[ID, PC <: DeclaredIds[ID], T](
		entity: Entity[ID, PC, T],
		o: T) = {
		val op = alreadyProcessed.get(o)
		if (op == null) {
			val tpe = entity.tpe
			val table = tpe.table
			val columnAndValues = table.toListOfColumnAndValueTuples(table.simpleTypeNotAutoGeneratedColumns, o)
			val op = InsertCmd(entity, o, columnAndValues)
			alreadyProcessed.put(o, op)
			op
		} else
			AlreadyProcessedCmd(entity, o)
	}
}